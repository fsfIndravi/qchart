/*! QChart | Â© 2018 Denis Seleznev | MIT License | https://github.com/hcodes/qchart/ */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.QChart=e()}(this,function(){"use strict";var t=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();var e=function(){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.name="qchart",this._main=t}return t(e,[{key:"create",value:function(t,e){var i=document.createElement(e||"div");return i.className=this.name+(t?"__"+t:""),i}},{key:"append",value:function(t,e){e?e.appendChild(t):this._main.appendChild(t)}},{key:"destroy",value:function(){this._main.innerHTML="",delete this._main}}]),e}(),i=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();var n=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._defaultOptions={backgroundColor:"#000",height:300,lineWidth:1,scale:1,middleLineWidth:2,middleLineColor:"#FFD963",middleDotBorderWidth:2,middleDotSize:5,middleDotBackgroundColor:"#000",color:"#FFF",color0:"#FFD963",color1:"#FD5A3E",color2:"#97CC64",color3:"#77B6E7",color4:"#A955B8",dateFormater:function(t){var e=new Date(t);function i(t){return t>9?t:"0"+t}return[e.getFullYear(),i(e.getMonth()+1),i(e.getDate())].join("-")},valueFormater:function(t){return t}},this._options=e||{}}return i(t,[{key:"get",value:function(t){var e=this._options[t];return void 0===e?this._defaultOptions[t]:e}},{key:"set",value:function(t,e){this._options[t]=e}},{key:"destroy",value:function(){delete this._options}}]),t}(),o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function s(t){var e=void 0,i=void 0;e=i=t[0][1];for(var n=0;n<t.length;n++)e=Math.min(e,t[n][1]),i=Math.max(i,t[n][1]);return{min:e,max:i}}function a(t,e,i){"number"==typeof i&&(i+="px"),t.style[e]=i}function r(t,e,i){"object"===(void 0===e?"undefined":o(e))?Object.keys(e).forEach(function(i){a(t,i,e[i])}):a(t,e,i)}var h=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();var l=function(){function t(i,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._main=i,this.elems=new e(i),this.options=n,this._dots=[]}return h(t,[{key:"create",value:function(t){this.remove();for(var e=0;e<t.length;e++){var i=this.elems.create("middle-dot");this._main.appendChild(i),this._dots.push(i)}this.setStyle(t)}},{key:"setStyle",value:function(t){var e=this.options.get("middleDotSize"),i=-this.options.get("middleDotSize")/2-this.options.get("middleDotBorderWidth"),n=this.options.get("middleDotBackgroundColor"),o=this.options.get("middleDotBorderWidth");this._dots.forEach(function(s,a){r(s,{borderColor:t[a]||this.options.get("color"+a),borderWidth:o,backgroundColor:n,marginLeft:i,marginTop:i,width:e,height:e})},this)}},{key:"setTop",value:function(t){this._dots.forEach(function(e,i){r(e,"top",t[i])})}},{key:"remove",value:function(){this._dots.forEach(function(t){t.parentNode.removeChild(t)}),this._dots=[]}},{key:"destroy",value:function(){this.remove(),this.elems.destroy(),delete this.elems,delete this.options,delete this._main}}]),t}(),d=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();var u=function(){function t(i,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._main=i,this.elems=new e(i),this.options=n,this._values=[]}return d(t,[{key:"create",value:function(t){this.remove();var e=this.elems.create("current-date");this._date=e,this._main.appendChild(e);var i=this.elems.create("current-values");this._main.appendChild(i);for(var n=0;n<t.length;n++){var o=this.elems.create("current-value");i.appendChild(o),this._values.push(o)}this.setStyle(t)}},{key:"setStyle",value:function(t){this._values.forEach(function(e,i){r(e,"color",t[i]||this.options.get("color"+i))},this)}},{key:"setValue",value:function(t,e){this._date.innerHTML=this.options.get("dateFormater")(t),this._values.forEach(function(t,i){t.innerHTML=this.options.get("valueFormater")(e[i],i)},this)}},{key:"remove",value:function(){this._values.forEach(function(t){t.parentNode.removeChild(t)}),this._values=[]}},{key:"destroy",value:function(){this.remove(),this.elems.destroy(),delete this.elems,delete this.options,delete this._main}}]),t}(),c=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();return function(){function t(i,o){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),(i="string"==typeof i?document.querySelector(i):i)&&(this._dom=i,this._dom.classList.add("qchart"),this.elems=new e(i),this.options=new n(o),this.clearData(),this.createBody(),this.updateOptions(),this.scales={year:2.5,month:5,day:10},this._buffers=[],this._width=this._manager.offsetWidth,this._height=this._manager.offsetHeight,this._cachedAreaWidth=1.5*this._width,this.bindEvents())}return c(t,[{key:"bindEvents",value:function(){var t=this;this._onresize=function(){t.resize()},this._onscroll=function(){t.scroll()},this._manager.addEventListener("scroll",this._onscroll,!1),window.addEventListener("resize",this._onresize,!1)}},{key:"unbindEvents",value:function(){this._manager.removeEventListener("scroll",this._onscroll,!1),window.removeEventListener("resize",this._onresize,!1)}},{key:"createBody",value:function(){var t=this.elems,e=t.create("current");t.append(e),this._current=new u(e,this.options);var i=t.create("container");t.append(i),this._middleLine=t.create("middle-line"),r(this._middleLine,{backgroundColor:this.options.get("middleLineColor"),width:this.options.get("middleLineWidth"),marginLeft:-this.options.get("middleLineWidth")/2}),t.append(this._middleLine,i);var n=t.create("middle-dots");t.append(n,i),this._middleDots=new l(n,this.options),this._manager=t.create("manager"),r(this._manager,"height",this.options.get("height")),t.append(this._manager,i),this._buffersContainer=t.create("buffers-container"),t.append(this._buffersContainer,this._manager),this._controls=t.create("controls"),t.append(this._controls)}},{key:"clearData",value:function(){this._data={series:[]}}},{key:"redraw",value:function(){this.updateOptions(),this.resize()}},{key:"setData",value:function(t){if(this.removeAllBuffers(),!(t&&Array.isArray(t.series)&&t.series.length))return this._dom.classList.remove("_has-data"),this.clearData(),this._middleDots.remove(),void this._current.remove();this._dom.classList.add("_has-data"),this._data=t,this._dataWidth=this._data.series[0].data.length*this.options.get("scale"),this._buffersContainer.style.width=this._dataWidth+"px";var e=this._data.series.map(function(t,e){return this.options.get("color"+e)},this);this._middleDots.create(e),this._current.create(e),this.addBuffers(),this._minMax=function(t){var e=s(t[0].data),i=e.min,n=e.max;if(t.length>1)for(var o=0;o<t.length;o++){var a=s(t[o].data);i=Math.min(a.min,i),n=Math.max(a.max,n)}return{min:i,max:n}}(this._data.series),this.draw()}},{key:"draw",value:function(){console.time("a");var t=this._manager.scrollLeft,e=t-this._cachedAreaWidth,i=t+this._cachedAreaWidth;this._buffers.forEach(function(t,n){var o=t.left,s=t.left+this._width;o>e&&o<i||s>e&&s<i?!t.canvas&&this.drawBuffer(t,n):this.removeBuffer(t)},this);var n=Math.floor((t+this._width/2-this._padding)/this.options.get("scale"));n<0&&(n=0);var o=this._data.series.map(function(t){var e=t.data.length-1,i=n;return i>e&&(i=e),this._calcY(t.data[i][1])},this);this._middleDots.setTop(o);var s=void 0,a=this._data.series.map(function(t){var e=t.data.length-1,i=n;return i>e&&(i=e),s=t.data[i][0],t.data[i][1]},this);this._current.setValue(s,a),console.timeEnd("a")}},{key:"drawBuffer",value:function(t,e){var i=t.canvas;i||(t.canvas=i=this.elems.create("buffer","canvas"),i.width=t.width,i.height=t.height,i.style.left=t.left+"px",this._buffersContainer.appendChild(i));var n=t.canvas.getContext("2d"),o=this.options.get("scale");n.fillStyle=this.options.get("backgroundColor"),n.fillRect(0,0,t.width,t.height),n.lineWidth=this.options.get("lineWidth");for(var s=0;s<this._data.series.length;s++){var a=this._data.series[s].data;n.strokeStyle=a.color||this.options.get("color"+s),n.beginPath();for(var r=0;r<a.length;r++){var h=r*o-e*this._width,l=this._calcY(a[r][1]);if(r?n.lineTo(h,l):n.moveTo(h,l),h>this._width)break}n.stroke()}}},{key:"_calcY",value:function(t){return this._height-t*this._height/this._minMax.max}},{key:"addBuffers",value:function(){for(var t=this.getCountBuffers(),e=0;e<t;e++)this._buffers.push({left:e*this._width,width:this._width,height:this._height,canvas:null});this._buffers[t-1].width=this._dataWidth-(t-1)*this._width}},{key:"removeBuffer",value:function(t){t.canvas&&(this._buffersContainer.removeChild(t.canvas),t.canvas=null)}},{key:"removeAllBuffers",value:function(){this._buffers.forEach(function(t){this.removeBuffer(t)},this),this._buffers=[]}},{key:"getCountBuffers",value:function(){var t=this._dataWidth/this._manager.offsetWidth,e=Math.floor(t);return t===e?t:e+1}},{key:"updateOptions",value:function(){r(this._dom,{backgroundColor:this.options.get("backgroundColor"),color:this.options.get("color")}),r(this._manager,"height",this.options.get("height")),this._updatePadding()}},{key:"scroll",value:function(){this.draw()}},{key:"resize",value:function(){var t=this._manager.offsetWidth,e=this._manager.offsetHeight;t===this._width&&e===this._height||(this._width=t,this._height=e,this.update())}},{key:"update",value:function(){this._updatePadding(),this.removeAllBuffers(),this.addBuffers(),this.draw()}},{key:"_updatePadding",value:function(){this._padding=this._manager.offsetWidth/2,this._buffersContainer.style.marginLeft=this._padding+"px",this._buffersContainer.style.paddingRight=this._padding+"px"}},{key:"destroy",value:function(){this.removeAllBuffers(),this.unbindEvents(),this.elems.destroy(),this.options.destroy(),delete this._dom}}]),t}()});