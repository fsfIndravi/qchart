/*! QChart | Â© 2019 Denis Seleznev | MIT License | https://github.com/hcodes/qchart/ */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.QChart=e()}(this,function(){"use strict";function s(t){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function n(t,e,i){return e&&o(t.prototype,e),i&&o(t,i),t}function a(t){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function i(t,e){return(i=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function h(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function c(t,e){var i=document.createElement(e||"div");return i.className="qchart__"+t,i}function u(t,e,i){"number"==typeof i&&(i+="px"),t.style[e]=i}function p(e,i,t){"object"===s(i)?Object.keys(i).forEach(function(t){u(e,t,i[t])}):u(e,i,t)}function f(t,e,i){var s,r;s=r=t[e][1];for(var o=e;o<i;o++)s=Math.min(s,t[o][1]),r=Math.max(r,t[o][1]);return{min:s,max:r}}function v(t,e,i){var s=f(t[0].data,e,i),r=s.min,o=s.max;if(1<t.length)for(var n=0;n<t.length;n++){var a=f(t[n].data,e,i);r=Math.min(a.min,r),o=Math.max(a.max,o)}return{min:r,max:o}}var e=function(){function t(){r(this,t),this._eventBuffer=[]}return n(t,[{key:"on",value:function(t,e){return t&&e&&this._eventBuffer.push({type:t,callback:e}),this}},{key:"off",value:function(t,e){for(var i=this._eventBuffer,s=0;s<i.length;s++)e===i[s].callback&&t===i[s].type&&(i.splice(s,1),s--);return this}},{key:"trigger",value:function(t,e){for(var i=this._eventBuffer,s=0;s<i.length;s++)t===i[s].type&&i[s].callback.call(this,{type:t},e);return this}},{key:"destroy",value:function(){delete this._eventBuffer}}]),t}(),d=function(){function e(t){r(this,e),this._defaultOptions={backgroundColor:"#000",height:300,lineWidth:1,scrollAlign:"right",period:"all",periods:[{value:"all",text:"All"},{value:"year",text:"Year",days:365},{value:"quarter",text:"Quarter",days:91},{value:"month",text:"Month",days:30}],middleLineWidth:2,middleLineColor:"#FFD963",middleDotBorderWidth:2,middleDotSize:5,middleDotBackgroundColor:"#000",color:"#FFF",color0:"#FFD963",color1:"#FD5A3E",color2:"#97CC64",color3:"#77B6E7",color4:"#A955B8",dateFormater:function(t){var e=new Date(t);function i(t){return 9<t?t:"0"+t}return[e.getFullYear(),i(e.getMonth()+1),i(e.getDate())].join("-")},valueFormater:function(t){return t}},this._options=t||{}}return n(e,[{key:"get",value:function(t){var e=this._options[t];return void 0===e?this._defaultOptions[t]:e}},{key:"set",value:function(t,e){this._options[t]=e}},{key:"destroy",value:function(){delete this._options}}]),e}(),l=function(){function i(t,e){r(this,i),this.$main=t,this.options=e,this.$dots=[]}return n(i,[{key:"create",value:function(t){this.remove();for(var e=0;e<t.length;e++){var i=c("middle-dot");this.$main.appendChild(i),this.$dots.push(i)}this.setStyle(t)}},{key:"setStyle",value:function(i){var s=this.options.get("middleDotSize"),r=-this.options.get("middleDotSize")/2-this.options.get("middleDotBorderWidth"),o=this.options.get("middleDotBackgroundColor"),n=this.options.get("middleDotBorderWidth");this.$dots.forEach(function(t,e){p(t,{borderColor:i[e]||this.options.get("color"+e),borderWidth:n,backgroundColor:o,marginLeft:r,marginTop:r,width:s,height:s})},this)}},{key:"setTop",value:function(i){this.$dots.forEach(function(t,e){p(t,"top",i[e])})}},{key:"remove",value:function(){this.$dots.forEach(function(t){t.parentNode.removeChild(t)}),this.$dots=[]}},{key:"destroy",value:function(){this.remove(),delete this.options,delete this.$main}}]),i}(),_=function(){function i(t,e){r(this,i),this.$main=t,this.options=e,this._values=[]}return n(i,[{key:"create",value:function(t){this.remove(),this.$date=c("current-date"),this.$main.appendChild(this.$date);var e=c("current-values");this.$main.appendChild(e);for(var i=0;i<t.length;i++){var s=c("current-value");e.appendChild(s),this._values.push(s)}this.setStyle(t)}},{key:"setStyle",value:function(i){var s=this;this._values.forEach(function(t,e){p(t,"color",i[e]||s.options.get("color"+e))})}},{key:"setValues",value:function(i,t){var s=this;this._values.forEach(function(t,e){t.innerHTML=s.options.get("valueFormater")(i[e],e)}),this.$date.innerHTML=this.options.get("dateFormater")(t)}},{key:"remove",value:function(){this._values.forEach(function(t){return t.parentNode.removeChild(t)}),this._values=[]}},{key:"destroy",value:function(){this.remove(),delete this._values,delete this.options,delete this.$main}}]),i}();return function(t){function s(t,e){var i;return r(this,s),i=h(this,a(s).call(this)),(t="string"==typeof t?document.querySelector(t):t)?(i.$dom=t,i.$dom.classList.add("qchart"),i.options=new d(e),i._period=i.options.get("period"),i._periodsByValue=(i.options.get("periods")||[]).reduce(function(t,e){return t[e.value]=e,t},{}),i._createBody(),i.updateOptions(),i._data=i._getEmptyData(),i._buffers=[],i._buffersWidth=i.$buffers.offsetWidth,i._buffersHeight=i.$buffers.offsetHeight,i._cachedAreaWidth=1.1*i._buffersWidth,i._bindEvents(),i):h(i)}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&i(t,e)}(s,e),n(s,[{key:"destroy",value:function(){this._removeAllBuffers(),this._unbindEvents(),this.options.destroy(),this._middleDots.destroy(),this._currentValues.destroy(),delete this.$periods,this.$dom.innerHTML="",delete this.$dom}},{key:"_getEmptyData",value:function(){return{series:[]}}},{key:"clearData",value:function(){this.setData(this._getEmptyData())}},{key:"setData",value:function(t){var i=this;if(this._removeAllBuffers(),!(t&&Array.isArray(t.series)&&t.series.length))return this.$dom.classList.remove("_has-data"),this._middleDots.remove(),this._currentValues.remove(),void(this._data=this._getEmptyData());this.$dom.classList.add("_has-data"),this._data=t,this._updateDataWidth(),this._updateScrollAlign();var e=this._data.series,s=e.map(function(t,e){return t.color||i.options.get("color"+e)});this._middleDots.create(s),this._currentValues.create(s),p(this.$dom,"color",this.options.get("color"+(1===e.length?"0":""))),this._addBuffers(),this._minMax=v(e),this.draw()}},{key:"setPeriod",value:function(t){if(t!==this._period){this.trigger("changeperiod",t),this._period=t;var e=this.$periods.querySelector("._selected");e&&e.classList.remove("_selected");var i=this.$periods.querySelector("._value_"+t);i&&i.classList.add("_selected"),this.update()}}},{key:"resize",value:function(){var t=this.$buffers.offsetWidth,e=this.$buffers.offsetHeight;t===this._buffersWidth&&e===this._buffersHeight||(this._buffersWidth=t,this._bufferHeight=e,this.update(),this.trigger("resize"))}},{key:"scroll",value:function(){this.draw(),this.trigger("scroll")}},{key:"updateOptions",value:function(){p(this.$dom,{backgroundColor:this.options.get("backgroundColor"),color:this.options.get("color")}),p(this.$middleLine,{backgroundColor:this.options.get("middleLineColor"),width:this.options.get("middleLineWidth"),marginLeft:-this.options.get("middleLineWidth")/2}),p(this.$buffers,"height",this.options.get("height")),this._updateBuffersPadding()}},{key:"update",value:function(){this._updateDataWidth(),this._updateBuffersPadding(),this._removeAllBuffers(),this._addBuffers(),this.draw()}},{key:"draw",value:function(){var e=this,n=this.$buffers.scrollLeft,t=this._data.series;this._buffers.forEach(function(t,e){var i,s,r,o;i=t.left,s=t.left+this._buffersWidth,r=n-this._cachedAreaWidth,o=n+this._cachedAreaWidth,r<i&&i<o||r<s&&s<o?
//!buffer.canvas && this._drawBuffer(buffer, num);
this._drawBuffer(t,e):this._removeBuffer(t)},this);var s,r=Math.floor((n+this._buffersWidth/2-this._buffersPadding)/this._getScale());r<0&&(r=0);var i=t.map(function(t){var e=t.data.length-1,i=r;return e<i&&(i=e),s=t.data[i][0],t.data[i][1]});this._currentValues.setValues(i,s),this._middleDots.setTop(i.map(function(t){return e._calcY(t)}))}},{key:"_drawBuffer",value:function(t,e){var i=t.canvas;i||(t.canvas=i=c("buffer","canvas"),i.width=t.width,i.height=t.height,p(i,"left",t.left),this.$buffersContainer.appendChild(i));var s=t.canvas.getContext("2d"),r=this._getScale();s.fillStyle=this.options.get("backgroundColor"),s.fillRect(0,0,t.width,t.height),s.lineWidth=this.options.get("lineWidth");var o=Math.floor((this.$buffers.scrollLeft-this.$buffers.offsetWidth/2)/this._getScale()),n=o+Math.floor(this.$buffers.offsetWidth/this._getScale()),a=this._data.series[0].data.length-1;o<0&&(o=0),a<o&&(o=a),n<0&&(n=0),a<n&&(n=a),this._minMax=v(this._data.series,o,n);for(var h=0;h<this._data.series.length;h++){var u=this._data.series[h].data;s.strokeStyle=u.color||this.options.get("color"+h),s.beginPath();for(var f=0;f<u.length;f++){var d=f*r-e*this._buffersWidth,l=this._calcY(u[f][1]);if(f?s.lineTo(d,l):s.moveTo(d,l),d>this._buffersWidth)break}s.stroke()}}},{key:"_createBody",value:function(){var t=c("current");this.$dom.appendChild(t),this._currentValues=new _(t,this.options);var e=c("container");this.$dom.appendChild(e),this.$middleLine=c("middle-line"),e.appendChild(this.$middleLine);var i=c("middle-dots");e.appendChild(i),this._middleDots=new l(i,this.options),this.$buffers=c("buffers"),e.appendChild(this.$buffers),this.$buffersContainer=c("buffers-container"),this.$buffers.appendChild(this.$buffersContainer),this._createPeriods()}},{key:"_createPeriods",value:function(){var i=this,t=this.options.get("periods");t&&(this.$periods=c("periods"),t.forEach(function(t){var e=c("period");e.dataset.value=t.value,e.innerHTML=t.text,e.classList.add("_value_"+t.value),i._period===t.value&&e.classList.add("_selected"),i.$periods.appendChild(e)}),this.$dom.appendChild(this.$periods))}},{key:"_bindEvents",value:function(){var i=this;this._onresize=this.resize.bind(this),this._onscroll=this.scroll.bind(this),this._onclickperiod=function(t){var e=t.target.dataset.value;e&&i.setPeriod(e)},this.$periods&&this.$periods.addEventListener("click",this._onclickperiod,!1),this.$buffers.addEventListener("scroll",this._onscroll,!1),window.addEventListener("resize",this._onresize,!1)}},{key:"_unbindEvents",value:function(){this.$periods&&this.$periods.removeEventListener("click",this._onclickperiod,!1),this.$buffers.removeEventListener("scroll",this._onscroll,!1),window.removeEventListener("resize",this._onresize,!1)}},{key:"_calcY",value:function(t){return this._buffersHeight-t*this._buffersHeight/this._minMax.max}},{key:"_addBuffers",value:function(){for(var t=this._getCountBuffers(),e=0;e<t;e++)this._buffers.push({left:e*this._buffersWidth,width:this._buffersWidth,height:this._buffersHeight,canvas:null});this._buffers[t-1].width=this._dataWidth-(t-1)*this._buffersWidth}},{key:"_removeBuffer",value:function(t){t.canvas&&(this.$buffersContainer.removeChild(t.canvas),t.canvas=null)}},{key:"_removeAllBuffers",value:function(){this._buffers.forEach(function(t){this._removeBuffer(t)},this),this._buffers=[]}},{key:"_getCountBuffers",value:function(){var t=this._dataWidth/this.$buffers.offsetWidth,e=Math.floor(t);return t===e?t:e+1}},{key:"_getScale",value:function(){var t=this.$buffers.offsetWidth;return"all"===this._period?t/this._data.series[0].data.length:t/this._periodsByValue[this._period].days}},{key:"_updateBuffersPadding",value:function(){this._buffersPadding=this.$buffers.offsetWidth/2,p(this.$buffersContainer,{marginLeft:this._buffersPadding,paddingRight:this._buffersPadding})}},{key:"_updateDataWidth",value:function(){this._dataWidth=(this._data.series[0].data.length-1)*this._getScale()||1,p(this.$buffersContainer,"width",this._dataWidth)}},{key:"_updateScrollAlign",value:function(){var t=this.options.get("scrollAlign");this.$buffers.scrollLeft="right"===t?this.$buffersContainer.offsetWidth+2*this._buffersPadding-this.$buffers.offsetWidth:0}}]),s}()});